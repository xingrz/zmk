/*
 * Copyright (c) 2022 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 */

/dts-v1/;
#include <st/f1/stm32f103Xb.dtsi>
#include <st/f1/stm32f103c(8-b)tx-pinctrl.dtsi>
#include <dt-bindings/led/led.h>
#include <dt-bindings/zmk/matrix_transform.h>

/ {
	model = "KB16-01";
	compatible = "st,stm32f103";

	chosen {
		zephyr,code-partition = &code_partition;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,console = &cdc_acm_uart;
		zephyr,display = &oled;
		zmk,kscan = &kscan;
		zmk,matrix_transform = &default_transform;
		zmk,underglow = &led_strip;
	};

	sensors {
		compatible = "zmk,keymap-sensors";
		sensors = <&ec1 &ec2 &ec3>;
	};

	kscan: kscan {
		compatible = "zmk,kscan-gpio-matrix";
		label = "KSCAN";

		diode-direction = "col2row";
		row-gpios = <&gpiob  3 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob  4 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob  9 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob  8 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
		col-gpios = <&gpiob 14 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob 13 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob 12 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpiob  0 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
		            <&gpioa  7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
	};

	default_transform: keymap_transform {
		compatible = "zmk,matrix-transform";
		columns = <16>;
		rows = <6>;
		map = <
			RC(0,0) RC(0,1) RC(0,2) RC(0,3) RC(0,4)
			RC(1,0) RC(1,1) RC(1,2) RC(1,3) RC(1,4)
			RC(2,0) RC(2,1) RC(2,2) RC(2,3) RC(2,4)
			RC(3,0) RC(3,1) RC(3,2) RC(3,3)
		>;
	};

	ec1: encoder1 {
		compatible = "alps,ec11";
		label = "EC_1";
		a-gpios = <&gpiob 5 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		b-gpios = <&gpiob 6 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		resolution = <4>;
	};

	ec2: encoder2 {
		compatible = "alps,ec11";
		label = "EC_2";
		a-gpios = <&gpioa 1 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		b-gpios = <&gpioa 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		resolution = <4>;
	};

	ec3: encoder3 {
		compatible = "alps,ec11";
		label = "EC_3";
		a-gpios = <&gpioa 3 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		b-gpios = <&gpioa 4 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
		resolution = <4>;
	};

	led_strip: ws2812 {
		compatible = "worldsemi,ws2812-pwm";
		label = "WS2812";
		chain-length = <16>;
		color-mapping = <LED_COLOR_ID_GREEN LED_COLOR_ID_RED LED_COLOR_ID_BLUE>;
		pwms = <&pwm1 3 0 PWM_POLARITY_NORMAL>;
		t0h-ns = <200>;
		t1h-ns = <1000>;
		period-ns = <2500>;
		reset-delay = <50>;
	};
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(8)>;
	status = "okay";
};

&pll {
	mul = <9>;
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(72)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <2>;
	apb2-prescaler = <1>;
};

&usb {
	pinctrl-0 = <&usb_dm_pa11 &usb_dp_pa12>;
	pinctrl-names = "default";
	status = "okay";
	cdc_acm_uart: cdc_acm_uart {
		compatible = "zephyr,cdc-acm-uart";
		label = "CDC_ACM_0";
	};
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		bootloader_partition: partition@0 {
			label = "bootloader";
			reg = <DT_SIZE_K(0) DT_SIZE_K(4)>;
		};

		code_partition: partition@1000 {
			label = "code_partition";
			reg = <DT_SIZE_K(4) DT_SIZE_K(122)>;
		};

		storage_partition: partition@1f800 {
			label = "storage";
			reg = <DT_SIZE_K(126) DT_SIZE_K(2)>;
		};
	};
};

&timers1 {
	status = "okay";
	pwm1: pwm {
		pinctrl-0 = <&tim1_ch3_pwm_pa10>;
		pinctrl-names = "default";
		status = "okay";
	};
};

&i2c2 {
	pinctrl-0 = <&i2c2_scl_pb10 &i2c2_sda_pb11>;
	pinctrl-names = "default";
	status = "okay";

	oled: ssd1306@3c {
		compatible = "solomon,ssd1306fb";
		reg = <0x3c>;
		label = "DISPLAY";
		width = <128>;
		height = <32>;
		segment-offset = <0>;
		page-offset = <0>;
		display-offset = <0>;
		multiplex-ratio = <31>;
		segment-remap;
		com-invdir;
		com-sequential;
		prechargep = <0x22>;
	};
};
